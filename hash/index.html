<!DOCTYPE html>
<html>
	<head>
		<meta charset="utf-8">
		<title>hash</title>
		<style type="text/css">
			@media(prefers-color-scheme:light)
			{
				body
				{
					background-color:white;
					color:black;
				}
			}
			@media(prefers-color-scheme:dark)
			{
				body
				{
					background-color:black;
					color:white;
				}
				a:link,a:hover,a:active,a:visited
				{
					color:#1d9bf0;
				}
			}
		</style>
	</head>
	<body>
		<script type="text/javascript">
			let g_mkch_wi;
			async function load_wasm()
			{
				const mkch_fp = fetch("mkch.wasm");
				const mkch_wp = WebAssembly.instantiateStreaming(mkch_fp);
				const mkch_w = await mkch_wp;
				const mkch_wi = mkch_w.instance;
				g_mkch_wi = mkch_wi;
			}
			function compute(id, xof_len, data, data_len)
			{
				const mem_start_offset = 0;
				const mem_start_len = 512 * 1024;
				const mem_data_offset = mem_start_offset + mem_start_len;
				const mem_data_len = 1 * 1024 * 1024;
				const mem_digest_offset = mem_data_offset + mem_data_len;
				const mem_digest_len = 16 * 1024;
				const mem_ret_len_offset = mem_digest_offset + mem_digest_len;
				const mem_ret_len_len = 4;
				if(!(data_len <= mem_data_len))
				{
					return false;
				}
				const data_buf = new Uint8Array(g_mkch_wi.exports.memory.buffer, mem_data_offset, mem_data_len);
				const digest_buf = new Uint8Array(g_mkch_wi.exports.memory.buffer, mem_digest_offset, mem_digest_len);
				const ret_len_buf = new Uint8Array(g_mkch_wi.exports.memory.buffer, mem_ret_len_offset, mem_ret_len_len);
				data_buf.set(new Uint8Array(data.buffer, 0, data_len));
				const r = g_mkch_wi.exports.mkch(id, xof_len, mem_data_offset, data_len, mem_digest_offset, mem_digest_len, mem_ret_len_offset);
				if(r == 0)
				{
					return false;
				}
				const alphabet = "0123456789abcdef";
				const n =
					((ret_len_buf[0] & 0xff) << (0 * 8)) |
					((ret_len_buf[1] & 0xff) << (1 * 8)) |
					((ret_len_buf[2] & 0xff) << (2 * 8)) |
					((ret_len_buf[3] & 0xff) << (3 * 8));
				const digest_str = new Uint8Array(n * 2);
				for(let i = 0; i != n; ++i)
				{
					const b = digest_buf[i] & 0xff;
					const hi = (b >> 4) & 0xf;
					const lo = (b >> 0) & 0xf;
					digest_str[i * 2 + 0] = alphabet.codePointAt(hi);
					digest_str[i * 2 + 1] = alphabet.codePointAt(lo);
				}
				return new TextDecoder().decode(digest_str);
			}
			function form_onsubmit()
			{
				const text = document.getElementById("text").value;
				const data = new Uint8Array(text.length * 3);
				const data_len = new TextEncoder().encodeInto(text, data).written;
				const alge = document.getElementById("alg");
				const is_shake = alge.value == "shake128" || alge.value == "shake256";
				document.getElementById("lengthl").hidden = !is_shake;
				document.getElementById("length").hidden = !is_shake;
				const xof_len_base = 64;
				const hash_name_base = alge.options[alge.selectedIndex].textContent;
				let xof_len;
				let hash_name;
				if(is_shake)
				{
					xof_len = document.getElementById("length").value;
					xof_len = parseInt(xof_len, 10);
					xof_len = Number.isNaN(xof_len) ? xof_len_base : xof_len;
					xof_len = xof_len <= 0 ? xof_len_base : xof_len;
					xof_len = xof_len > 16 * 1024 ? xof_len_base : xof_len;
					hash_name = hash_name_base + "(" + (xof_len * 8) + ")";
				}
				else
				{
					xof_len = xof_len_base;
					hash_name = hash_name_base;
				}
				const computed = compute(alge.selectedIndex, xof_len, data, data_len);
				if(computed == false)
				{
					document.getElementById("resulto").hidden = true;
				}
				else
				{
					document.getElementById("resulta").textContent = hash_name;
					document.getElementById("resultb").textContent = computed;
					document.getElementById("resulto").hidden = false;
				}
				return false;
			}
			load_wasm();
		</script>
		<span>hash</span>
		<br>
		<br>
		<a href="..">back</a>
		<br>
		<br>
		<form onsubmit="return form_onsubmit()">
			<label for="text">text:</label>
			<br>
			<textarea id="text" cols="60" rows="5" oninput="form_onsubmit()" placeholder="insert text here"></textarea>
			<br>
			<br>
			<label for="alg">algorithm:</label>
			<select id="alg" onchange="form_onsubmit()">
				<option value="md2">MD2</option>
				<option value="md4">MD4</option>
				<option value="md5">MD5</option>
				<option value="sha0">SHA-0</option>
				<option value="sha1" selected>SHA-1</option>
				<option value="sha2224">SHA-224</option>
				<option value="sha2256">SHA-256</option>
				<option value="sha2384">SHA-384</option>
				<option value="sha2512">SHA-512</option>
				<option value="sha2512224">SHA-512/224</option>
				<option value="sha2512256">SHA-512/256</option>
				<option value="sha3224">SHA3-224</option>
				<option value="sha3256">SHA3-256</option>
				<option value="sha3384">SHA3-384</option>
				<option value="sha3512">SHA3-512</option>
				<option value="shake128">SHAKE128</option>
				<option value="shake256">SHAKE256</option>
			</select>
			<br>
			<br>
			<label id="lengthl" for="length" hidden>length:</label>
			<input id="length" type="number" min="1" step="1" value="64" hidden onchange="form_onsubmit()">
			<br>
			<br>
			<input type="submit">
		</form>
		<br>
		<br>
		<span id="resulto" hidden><span id="resulta"></span> hash of your input is <span id="resultb" style="font-family:monospace; display:block; word-break:break-all;"></span>.</span>
	</body>
</html>
