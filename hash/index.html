<!DOCTYPE html>
<html>
	<head>
		<meta charset="utf-8">
		<title>hash</title>
		<style type="text/css">
			@media(prefers-color-scheme:light)
			{
				body
				{
					background-color:white;
					color:black;
				}
			}
			@media(prefers-color-scheme:dark)
			{
				body
				{
					background-color:black;
					color:white;
				}
				a:link,a:hover,a:active,a:visited
				{
					color:#1d9bf0;
				}
			}
		</style>
	</head>
	<body>
		<script type="text/javascript">
			let g_mkch_wi;
			async function load_wasm()
			{
				const mkch_fp = fetch("mkch.wasm");
				const mkch_wp = WebAssembly.instantiateStreaming(mkch_fp);
				const mkch_w = await mkch_wp;
				const mkch_wi = mkch_w.instance;
				g_mkch_wi = mkch_wi;
			}
			function compute(alg_name, alg_name_len, xof_len, data, data_len)
			{
				const mem_start_offset = 0;
				const mem_start_len = 512 * 1024;
				const mem_data_offset = mem_start_offset + mem_start_len;
				const mem_data_len = 1 * 1024 * 1024;
				const mem_alg_name_offset = mem_data_offset + mem_data_len;
				const mem_alg_name_len = 0xff;
				const mem_digest_offset = mem_alg_name_offset + mem_alg_name_len;
				const mem_digest_len = 16 * 1024;
				if(!(alg_name_len >= 1 && alg_name_len <= mem_alg_name_len))
				{
					return false;
				}
				if(!(data_len >= 0 && data_len <= mem_data_len))
				{
					return false;
				}
				const mem_data_buff = new Uint8Array(g_mkch_wi.exports.memory.buffer, mem_data_offset, mem_data_len);
				const mem_alg_name_buff = new Uint8Array(g_mkch_wi.exports.memory.buffer, mem_alg_name_offset, mem_alg_name_len);
				const mem_digest_buff = new Uint8Array(g_mkch_wi.exports.memory.buffer, mem_digest_offset, mem_digest_len);
				mem_data_buff.set(new Uint8Array(data.buffer, 0, data_len));
				mem_alg_name_buff.set(new Uint8Array(alg_name.buffer, 0, alg_name_len));
				const mkch_ret = g_mkch_wi.exports.mkch(mem_alg_name_offset, alg_name_len, xof_len, mem_data_offset, data_len, mem_digest_offset, mem_digest_len);
				if(mkch_ret == 0)
				{
					return false;
				}
				const alphabet = "0123456789abcdef";
				const n = mkch_ret;
				const digest_str = new Uint8Array(n * 2);
				for(let i = 0; i != n; ++i)
				{
					const b = mem_digest_buff[i] & 0xff;
					const hi = (b >> 4) & 0xf;
					const lo = (b >> 0) & 0xf;
					digest_str[i * 2 + 0] = alphabet.codePointAt(hi);
					digest_str[i * 2 + 1] = alphabet.codePointAt(lo);
				}
				return new TextDecoder().decode(digest_str);
			}
			function form_onsubmit()
			{
				const text = document.getElementById("text").value;
				const data = new Uint8Array(text.length * 3);
				const data_len = new TextEncoder().encodeInto(text, data).written;
				const alge = document.getElementById("alg");
				const alg_name = new Uint8Array(0xff);
				const alg_name_len = new TextEncoder().encodeInto(alge.value, alg_name).written;
				const is_shake = alge.value == "shake_128" || alge.value == "shake_256";
				document.getElementById("lengthl").hidden = !is_shake;
				document.getElementById("length").hidden = !is_shake;
				const xof_len_base = 64;
				const hash_name_base = alge.options[alge.selectedIndex].textContent;
				let xof_len;
				let hash_name;
				if(is_shake)
				{
					xof_len = document.getElementById("length").value;
					xof_len = parseInt(xof_len, 10);
					xof_len = Number.isNaN(xof_len) ? xof_len_base : xof_len;
					xof_len = xof_len <= 0 ? xof_len_base : xof_len;
					xof_len = xof_len > 16 * 1024 ? xof_len_base : xof_len;
					hash_name = hash_name_base + "(" + (xof_len * 8) + ")";
				}
				else
				{
					xof_len = xof_len_base;
					hash_name = hash_name_base;
				}
				const computed = compute(alg_name, alg_name_len, xof_len, data, data_len);
				if(computed == false)
				{
					document.getElementById("resulto").hidden = true;
				}
				else
				{
					document.getElementById("resulta").textContent = hash_name;
					document.getElementById("resultb").textContent = computed;
					document.getElementById("resulto").hidden = false;
				}
				return false;
			}
			load_wasm();
		</script>
		<span>hash</span>
		<br>
		<br>
		<a href="..">back</a>
		<br>
		<br>
		<form onsubmit="return form_onsubmit()">
			<label for="text">text:</label>
			<br>
			<textarea id="text" cols="60" rows="5" oninput="form_onsubmit()" placeholder="insert text here"></textarea>
			<br>
			<br>
			<label for="alg">algorithm:</label>
			<select id="alg" onchange="form_onsubmit()">
				<option value="md2">MD2</option>
				<option value="md4">MD4</option>
				<option value="md5">MD5</option>
				<option value="sha0">SHA-0</option>
				<option value="sha1" selected>SHA-1</option>
				<option value="sha2_224">SHA-224</option>
				<option value="sha2_256">SHA-256</option>
				<option value="sha2_384">SHA-384</option>
				<option value="sha2_512">SHA-512</option>
				<option value="sha2_512_224">SHA-512/224</option>
				<option value="sha2_512_256">SHA-512/256</option>
				<option value="sha3_224">SHA3-224</option>
				<option value="sha3_256">SHA3-256</option>
				<option value="sha3_384">SHA3-384</option>
				<option value="sha3_512">SHA3-512</option>
				<option value="shake_128">SHAKE128</option>
				<option value="shake_256">SHAKE256</option>
				<option value="tiger_128">Tiger/128</option>
				<option value="tiger_160">Tiger/160</option>
				<option value="tiger_192">Tiger/192</option>
				<option value="tiger2_128">Tiger2/128</option>
				<option value="tiger2_160">Tiger2/160</option>
				<option value="tiger2_192">Tiger2/192</option>
			</select>
			<br>
			<br>
			<label id="lengthl" for="length" hidden>length:</label>
			<input id="length" type="number" min="1" max="16384" step="1" value="64" hidden onchange="form_onsubmit()">
			<br>
			<br>
			<input type="submit" value="compute">
		</form>
		<br>
		<br>
		<span id="resulto" hidden><span id="resulta"></span> hash of your input is <span id="resultb" style="font-family:monospace; display:block; word-break:break-all;"></span>.</span>
	</body>
</html>
